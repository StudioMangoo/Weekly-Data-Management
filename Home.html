<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Çalışma Takip Formu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHcSURBVDhPrZM9a1NxFMZ/597kpgk0SKFk00gaMogUaqmISsBB8AP4Abpk8zs4OyniopQMDg6Cg5OIDaZBhxgK0UXSCqEItSm+oJI0997c4/DvfesgCD7T4TnPOYfzJpxA0M6uYEsDlWsoZQCEIaItZvrQqnvbSb2EhvYo6Ni5D7IuEvNJqKKgTSm4t2SVMWEC7VHQifNSkMuR2p6H/JKxJ7sw+xW5FH0jefd6mIRgy9nQTk61k1PtVlUPn6kGnkYIPMN1q0bTyWmw5WwASNDOriBWTwRhrgzLbciWomopuAfwvg5HQ9OOBqsWtjSiniv30sE/NqF3Dt7VYPQYnBJU7gIggmBLQ4JObiBQxSnB2jCeqzcywWHvYsOFDzB3FrplcA9Q2LF8/3hV+VpyKbD/KDU4dAaTHaPJ1wDwfcpWxo41EUZP4POdNGcXYf5iisrYYCEMAZgMAIWfb2GwDsE0VooNSw8gc8poxh+PeYYWoi0A3C/wfROKl+DMbcidhswCLNyA869g8aYJ+vbCzAdAtHVijRVYfg3ZxbB2Gu4+9Osw3YvXaG5bmwAcfYL+Vfj6HNSPA9WDw6fQvwLTvZBsWnVv+y+nXIR8xfQ82YXZ78iVPOX/80xJ/Os7/wHknuoMxuX5kQAAAABJRU5ErkJggg==">
  <style>
    #loadingBar {
      position: relative;
      width: 100%;
      height: 4px;
      background-color: transparent;
      overflow: hidden;
      border-radius: 9999px;
    }
    #loadingBar::before {
      content: "";
      position: absolute;
      background-color: #2563eb;
      top: 0;
      bottom: 0;
      left: -40%;
      right: 100%;
      animation: loading-indeterminate 1.5s infinite;
      border-radius: 9999px;
    }
    @keyframes loading-indeterminate {
      0% {
        left: -40%;
        right: 100%;
      }
      60% {
        left: 100%;
        right: -40%;
      }
      100% {
        left: 100%;
        right: -40%;
      }
    }
  </style>
</head>
<body class="bg-gray-100 p-8">

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="w-80 bg-white rounded-md shadow p-4 flex flex-col items-center">
      <div class="w-full h-1 rounded overflow-hidden mb-3">
        <div id="loadingBar"></div>
      </div>
      <span id="loadingText" class="text-gray-700 font-medium whitespace-nowrap">Yükleniyor...</span>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="w-80 bg-white rounded-xl shadow p-6 flex flex-col items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
      <span class="text-lg font-semibold text-gray-800 mb-2">İşlem tamamlandı</span>
      <span class="text-gray-600 mb-4">Form verileriniz başarıyla kaydedildi.</span>
      <button id="successCloseBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Kapat</button>
    </div>
  </div>

  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="w-96 bg-white rounded-xl shadow p-8 flex flex-col items-center">
      <h2 class="text-xl font-bold mb-4">Giriş Yap</h2>
      <input id="loginMail" type="email" placeholder="E-posta" class="w-full border p-2 rounded mb-3" required />
      <input id="loginPassword" type="password" placeholder="Şifre" class="w-full border p-2 rounded mb-4" required />
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Giriş Yap</button>
      <span id="loginError" class="text-red-600 text-sm mt-3 hidden"></span>
    </div>
  </div>
  <div id="loginSuccess" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-xl shadow p-8 flex flex-col items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
      <span class="text-lg font-semibold text-green-700 mb-2">Giriş başarılı</span>
    </div>
  </div>
  <script>
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const loginMail = document.getElementById('loginMail');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');
    const loginSuccess = document.getElementById('loginSuccess');

    function showLoginError(msg) {
      loginError.textContent = msg;
      loginError.classList.remove('hidden');
    }

    loginBtn.addEventListener('click', async function() {
      const mail = loginMail.value.trim();
      const password = loginPassword.value;
      if (!mail || !password) {
        showLoginError('Lütfen e-posta ve şifre girin.');
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Kontrol ediliyor...';
      loginError.classList.add('hidden');
      loginBtn.classList.add('bg-gray-400');
      loginBtn.classList.remove('bg-blue-600','hover:bg-blue-700');
      try {
        const params = new URLSearchParams({
          apiKey: 'yKybsCyyUsWBSrm',
          islem: 'offlineTabloVeriCekme',
          mail,
          password,
          authCheck: 'false'
        });
        const url = 'https://script.google.com/macros/s/AKfycbxTjUAytwmQneovY73plfp3rO6NN8ndGNKpUPEhb2wtquwYN0yoWODvSfCQ06WJ6GAE/exec?' + params.toString();
        const res = await fetch(url);
        const json = await res.json();
        if (json.status === 'success' && json.message.calismaTuru) {
          loginSuccess.classList.remove('hidden');
          setTimeout(() => {
            loginSuccess.classList.add('hidden');
            loginModal.classList.add('hidden');
            document.body.style.overflow = '';
            document.getElementById('mainContent').style.display = '';

            // İsimler kontrolü
            const isimler = json.message.isimler || [];
            if (isimler.length > 1) {
              // Admin formu
              document.getElementById('formUser').style.display = 'none';
              document.getElementById('formAdmin').style.display = '';
              // Admin formu için isim dropdown ve listeyi doldur
              window.isimlerListesi = isimler;
              document.getElementById('formTitle').textContent = 'Haftalık Çalışma Girişi (Yetkili)';
              // Giriş yapan kişinin ismini öneri olarak göster
              const adminIsimOneriDiv = document.getElementById('adminIsimOneri');
              const girisYapanIsim = window.isimlerListesi[0];
              adminIsimOneriDiv.innerHTML = `<button type="button" id="adminIsimOneriBtn" class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">İsminizi hızlıca seçmek için tıklayın: <b>${girisYapanIsim}</b></button>`;
              document.getElementById('adminIsimOneriBtn').onclick = function() {
                const isimInput = document.getElementById('admin_isimInput');
                isimInput.value = girisYapanIsim;
                isimSecildi = true;
                guncelleIsimDropdown();
                updateVisibility();
                isimInput.focus();
                // Çalışma türü alanına da focus ver
                setTimeout(() => {
                  const calismaTuru = document.getElementById('admin_calismaTuru');
                  if (calismaTuru) calismaTuru.focus();
                }, 0);
              };
              // calismaTuru ve urunTuru doldur
              const calismaTuru = document.getElementById('admin_calismaTuru');
              const urunTuru = document.getElementById('admin_urunTuru');
              calismaTuru.innerHTML = '<option value="">Seçiniz</option>' +
                json.message.calismaTuru.filter(opt => opt !== "Maaşlı").map(opt => `<option value="${opt}">${opt}</option>`).join('');
              urunTuru.innerHTML = '<option value="">Seçiniz</option>' +
                json.message.urunTuru.filter(opt => opt !== "Workshop").map(opt => opt === "Yok" ? `<option value="Yok">Diğer</option>` : `<option value="${opt}">${opt}</option>`).join('');
            } else {
              // Normal kullanıcı formu
              document.getElementById('formUser').style.display = '';
              document.getElementById('formAdmin').style.display = 'none';
              document.getElementById('user_mailDisplay').textContent = mail;
              document.getElementById('user_mail').value = mail;
              // Giriş yapan kişinin ismini sakla
              if (isimler.length === 1) {
                window.girisYapanIsim = isimler[0];
              } else {
                window.girisYapanIsim = '';
              }
              // calismaTuru ve urunTuru doldur
              const calismaTuru = document.getElementById('user_calismaTuru');
              const urunTuru = document.getElementById('user_urunTuru');
            calismaTuru.innerHTML = '<option value="">Seçiniz</option>' +
                json.message.calismaTuru.filter(opt => !["Ürün Bazlı", "Diğer"].includes(opt)).map(opt => `<option value="${opt}">${opt}</option>`).join('');
            urunTuru.innerHTML = '<option value="">Seçiniz</option>' +
                json.message.urunTuru.filter(opt => !["Workshop", "AI İçin Dekupe"].includes(opt)).map(opt => opt === "Yok" ? `<option value="Yok">Diğer</option>` : `<option value="${opt}">${opt}</option>`).join('');
            document.getElementById('formTitle').textContent = 'Haftalık Çalışma Girişi';
            // Normal kullanıcıda öneri kutusunu gizle
            document.getElementById('adminIsimOneri').innerHTML = '';
            }
            updateVisibility();
          }, 1200);
        } else {
          showLoginError((json.message && json.message.error) || 'Giriş başarısız.');
        }
      } catch (e) {
        showLoginError('Sunucuya ulaşılamadı.');
      }
      loginBtn.disabled = false;
      loginBtn.textContent = 'Giriş Yap';
      loginBtn.classList.remove('bg-gray-400');
      loginBtn.classList.add('bg-blue-600','hover:bg-blue-700');
    });

    function handleLoginOnEnter(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        loginBtn.click();
      }
    }
    loginMail.addEventListener('keydown', handleLoginOnEnter);
    loginPassword.addEventListener('keydown', handleLoginOnEnter);
    
    // Sayfa açılışında scroll'u engelle
    document.body.style.overflow = 'hidden';
  </script>

  <div id="mainContent" style="display:none">
    <div class="w-full flex flex-col items-center mt-8 mb-8">
      <img src="data:image/png;base64,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" alt="Logo" class="h-16 w-16 object-contain" />
      <span class="mt-2 text-2xl font-bold tracking-wide text-gray-800 select-none">Studio Mangoo</span>
    </div>
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow" id="formContainer">
      <h2 id="formTitle" class="text-2xl font-bold mb-4">Haftalık Çalışma Girişi</h2>

      <!-- Normal Kullanıcı Formu -->
      <form id="formUser" class="space-y-4" autocomplete="off" style="display:none">
        <div class="mb-2">
          <span class="block font-medium">Mail:</span>
          <span id="user_mailDisplay" class="block text-blue-700 font-semibold select-none"></span>
          <input type="hidden" id="user_mail" name="mail" />
        </div>
        <div id="user_calismaTuruDiv" style="display:none">
          <label class="block font-medium">Çalışma Türü <span class="text-red-500">*</span></label>
          <select required id="user_calismaTuru" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Yükleniyor...</option>
          </select>
        </div>
        <div id="user_urunTuruDiv" style="display:none">
          <label class="block font-medium">Ürün Türü <span class="text-red-500">*</span></label>
          <select required id="user_urunTuru" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Yükleniyor...</option>
          </select>
        </div>
        <div id="user_urunOzelligiDiv" style="display:none">
          <label class="block font-medium">Ürün Özelliği <span class="text-red-500">*</span></label>
          <select required id="user_urunOzelligi" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Seçiniz</option>
            <option value="Orijinal">Orijinal</option>
            <option value="Versiyon">Versiyon</option>
          </select>
        </div>
        <div id="user_adetDiv" style="display:none">
          <label class="block font-medium">Adet</label>
          <input type="number" min="1" id="user_adet" class="w-full border p-2 rounded" autocomplete="off" />
        </div>
        <div id="user_calisilanSureDiv" style="display:none">
          <label class="block font-medium">Çalışılan Süre</label>
          <input type="text" id="user_calisilanSure" class="w-full border p-2 rounded" placeholder="__:__" maxlength="6" autocomplete="off" />
          <small class="text-gray-500">Saat:Dakika formatında giriniz (örn: 25:30)</small>
        </div>
        <div id="user_isDiv" style="display:none">
          <label class="block font-medium">İş Tanımı / ID <span class="text-red-500">*</span></label>
          <input type="text" id="user_is" class="w-full border p-2 rounded" autocomplete="off" />
        </div>
        <div id="user_odemeDiv" style="display:none">
          <label class="block font-medium">Ödeme Durumu</label>
          <select id="user_odeme" class="w-full border p-2 rounded" autocomplete="off">
            <option value=""></option>
            <option value="Yapıldı">Yapıldı</option>
          </select>
        </div>
        <div id="user_urunDurumuDiv" style="display:none">
          <label class="block font-medium">Ürün Durumu</label>
          <select id="user_urunDurumu" class="w-full border p-2 rounded" autocomplete="off">
            <option value=""></option>
            <option value="Bitmedi">Bitmedi</option>
          </select>
        </div>
        <button type="submit" id="user_submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 hidden">
          Kaydet
        </button>
      </form>

      <!-- Admin Formu (isim seçmeli) -->
      <div id="adminIsimOneri" class="mb-2"></div>
      <form id="formAdmin" class="space-y-4" autocomplete="off" style="display:none">
        <div style="position:relative">
          <label class="block font-medium">İsim <span class="text-red-500">*</span></label>
          <input id="admin_isimInput" type="text" placeholder="İsim ara veya seç..." class="w-full border p-2 rounded mb-2" autocomplete="off" required />
          <div id="admin_isimDropdown" class="absolute left-0 right-0 bg-white border rounded shadow z-10 max-h-48 overflow-y-auto hidden"></div>
          <span id="admin_isimError" class="text-red-600 text-sm mt-1 hidden">Lütfen listeden bir isim seçin.</span>
        </div>
        <div id="admin_calismaTuruDiv" style="display:none">
          <label class="block font-medium">Çalışma Türü <span class="text-red-500">*</span></label>
          <select required id="admin_calismaTuru" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Yükleniyor...</option>
          </select>
        </div>
        <div id="admin_urunTuruDiv" style="display:none">
          <label class="block font-medium">Ürün Türü <span class="text-red-500">*</span></label>
          <select required id="admin_urunTuru" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Yükleniyor...</option>
          </select>
        </div>
        <div id="admin_urunOzelligiDiv" style="display:none">
          <label class="block font-medium">Ürün Özelliği <span class="text-red-500">*</span></label>
          <select required id="admin_urunOzelligi" class="w-full border p-2 rounded" autocomplete="off">
            <option value="">Seçiniz</option>
            <option value="Orijinal">Orijinal</option>
            <option value="Versiyon">Versiyon</option>
          </select>
        </div>
        <div id="admin_adetDiv" style="display:none">
          <label class="block font-medium">Adet</label>
          <input type="number" min="1" id="admin_adet" class="w-full border p-2 rounded" autocomplete="off" />
        </div>
        <div id="admin_calisilanSureDiv" style="display:none">
          <label class="block font-medium">Çalışılan Süre</label>
          <input type="text" id="admin_calisilanSure" class="w-full border p-2 rounded" placeholder="__:__" maxlength="6" autocomplete="off" />
          <small class="text-gray-500">Saat:Dakika formatında giriniz (örn: 25:30)</small>
        </div>
        <div id="admin_isDiv" style="display:none">
          <label class="block font-medium">İş Tanımı / ID <span class="text-red-500">*</span></label>
          <input type="text" id="admin_is" class="w-full border p-2 rounded" autocomplete="off" />
        </div>
        <div id="admin_odemeDiv" style="display:none">
          <label class="block font-medium">Ödeme Durumu</label>
          <select id="admin_odeme" class="w-full border p-2 rounded" autocomplete="off">
            <option value=""></option>
            <option value="Yapıldı">Yapıldı</option>
          </select>
        </div>
        <div id="admin_urunDurumuDiv" style="display:none">
          <label class="block font-medium">Ürün Durumu</label>
          <select id="admin_urunDurumu" class="w-full border p-2 rounded" autocomplete="off">
            <option value=""></option>
            <option value="Bitmedi">Bitmedi</option>
          </select>
        </div>
        <button type="submit" id="admin_submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 hidden">
          Kaydet
        </button>
      </form>
    </div>
  </div>
  <script>
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxTjUAytwmQneovY73plfp3rO6NN8ndGNKpUPEhb2wtquwYN0yoWODvSfCQ06WJ6GAE/exec";
    const loadingModal = document.getElementById("loadingModal");

    function showLoading(text, hideForm) {
      if (text) {
        document.getElementById("loadingText").textContent = text;
      }
      loadingModal.classList.remove("hidden");
      if (hideForm) {
        document.getElementById("formContainer").style.opacity = "0";
        document.getElementById("formContainer").style.pointerEvents = "none";
      } else {
        document.getElementById("formContainer").style.opacity = "1";
        document.getElementById("formContainer").style.pointerEvents = "auto";
      }
    }
    function hideLoading() {
      loadingModal.classList.add("hidden");
      document.getElementById("formContainer").style.opacity = "1";
      document.getElementById("formContainer").style.pointerEvents = "auto";
    }

    function sureyiDakikayaCevir(sureStr) {
      if (!sureStr) return "";
      const match = sureStr.match(/^([0-9]{1,3}):([0-5][0-9])$/);
      if (match) {
        const saat = parseInt(match[1], 10) || 0;
        const dakika = parseInt(match[2], 10) || 0;
        return saat * 60 + dakika;
      }
      return "";
    }

    function setVisibility(prefix, id, visible) {
      const div = document.getElementById(prefix + id + "Div");
      if (!div) return;
      const el = document.getElementById(prefix + id);
      if (!el) return;
      const isCurrentlyVisible = div.style.display !== "none";
      if (visible !== isCurrentlyVisible) {
        div.style.display = visible ? "block" : "none";
      }
      if (visible) {
        if (!["odeme", "urunDurumu"].includes(id)) {
          el.setAttribute("required", "required");
        } else {
          el.removeAttribute("required");
        }
      } else {
        el.removeAttribute("required");
      }
    }

    function updateVisibility(mode) {
      const isAdmin = document.getElementById('formAdmin').style.display !== 'none';
      const prefix = isAdmin ? 'admin_' : 'user_';
      const submitBtn = document.getElementById(prefix + 'submitBtn');
      const calismaTuru = document.getElementById(prefix + 'calismaTuru');
      const urunTuru = document.getElementById(prefix + 'urunTuru');
      const urunOzelligi = document.getElementById(prefix + 'urunOzelligi');
      const adet = document.getElementById(prefix + 'adet');
      const isInput = document.getElementById(prefix + 'is');
      const odeme = document.getElementById(prefix + 'odeme');
      const calisilanSureDiv = document.getElementById(prefix + 'calisilanSureDiv');
      const urunDurumuDiv = document.getElementById(prefix + 'urunDurumuDiv');
      const calisilanSure = document.getElementById(prefix + 'calisilanSure');
      const urunDurumu = document.getElementById(prefix + 'urunDurumu');
      if (mode === 'onlyCalismaTuru') {
        setVisibility(prefix, 'calismaTuru', true);
        ['urunTuru', 'urunOzelligi', 'adet', 'is', 'odeme', 'calisilanSure', 'urunDurumu'].forEach(id => setVisibility(prefix, id, false));
        submitBtn.classList.add('hidden');
        return;
      }
      submitBtn.classList.add("hidden");
      submitBtn.textContent = "Kaydet";
      if (isAdmin) {
        const isimInput = document.getElementById('admin_isimInput');
        if (isimInput.value.trim() === "") {
          ["calismaTuru", "urunTuru", "urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        return;
      }
      } else {
        if (document.getElementById('user_mail').value.trim() === "") {
          ["calismaTuru", "urunTuru", "urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        return;
        }
      }
      setVisibility(prefix, "calismaTuru", true);
      const calisma = calismaTuru.value;
      const urun = urunTuru.value;
      const ozellik = urunOzelligi.value;
      const adetVal = adet.value.trim();
      const isVal = isInput.value.trim();
      const odemeVal = odeme.value;
      const calisilanSureVal = calisilanSure.value.trim();
      const urunDurumuVal = urunDurumu.value;
      const includesTasarim = urun.includes("Tasarım");
      if (calisma === "Çalışma Yok" || calisma === "Maaşlı") {
        ["urunTuru", "urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        submitBtn.classList.remove("hidden");
        return;
      }
      if (calisma === "Diğer") {
        setVisibility(prefix, "adet", true);
        ["urunTuru", "urunOzelligi", "odeme", "calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        if (adetVal !== "") {
          setVisibility(prefix, "is", true);
          if (isVal !== "") {
            submitBtn.classList.remove("hidden");
          }
        } else {
          setVisibility(prefix, "is", false);
        }
        return;
      }
      if (calisma === "Ürün Bazlı") {
        setVisibility(prefix, "urunTuru", true);
        ["calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        if (urun === "Yok" || urun === "Workshop" || urun === "") {
          ["urunOzelligi", "adet", "is", "odeme"].forEach(id => setVisibility(prefix, id, false));
          return;
        }
        if (urun === "AI İçin Dekupe") {
          setVisibility(prefix, "adet", true);
          ["urunOzelligi", "odeme"].forEach(id => setVisibility(prefix, id, false));
          if (adetVal !== "") {
            setVisibility(prefix, "is", true);
            if (isVal !== "") {
              submitBtn.classList.remove("hidden");
            }
          } else {
            setVisibility(prefix, "is", false);
          }
          return;
        }
        if (includesTasarim) {
          setVisibility(prefix, "urunOzelligi", true);
          if (ozellik !== "") {
            setVisibility(prefix, "adet", true);
            if (adetVal !== "") {
              setVisibility(prefix, "is", true);
              if (isVal !== "") {
                submitBtn.textContent = "Gönder";
                submitBtn.classList.remove("hidden");
              }
            } else {
              setVisibility(prefix, "is", false);
            }
          } else {
            setVisibility(prefix, "adet", false);
            setVisibility(prefix, "is", false);
          }
          return;
        } else {
          setVisibility(prefix, "urunOzelligi", true);
          setVisibility(prefix, "adet", false);
          if (ozellik !== "") {
            setVisibility(prefix, "is", true);
            if (isVal !== "") {
              setVisibility(prefix, "odeme", true);
              submitBtn.textContent = "Gönder";
              submitBtn.classList.remove("hidden");
            } else {
              setVisibility(prefix, "odeme", false);
            }
          } else {
            setVisibility(prefix, "is", false);
            setVisibility(prefix, "odeme", false);
          }
          return;
        }
      }
      if (calisma === "Saatlik") {
        setVisibility(prefix, "urunTuru", true);
        ["urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"].forEach(id => setVisibility(prefix, id, false));
        if (!urun) return;
        if (urun === "Yok" || urun === "Workshop") {
          setVisibility(prefix, "calisilanSure", true);
          setVisibility(prefix, "adet", false);
          if (calisilanSureVal !== "") {
            setVisibility(prefix, "is", true);
            if (isVal !== "") {
              submitBtn.classList.remove("hidden");
            }
          } else {
            setVisibility(prefix, "is", false);
          }
          return;
        }
        if (urun === "AI İçin Dekupe") {
          setVisibility(prefix, "adet", true);
          setVisibility(prefix, "urunOzelligi", false);
          if (adetVal !== "") {
            setVisibility(prefix, "calisilanSure", true);
            if (calisilanSureVal !== "") {
              setVisibility(prefix, "is", true);
              if (isVal !== "") {
                submitBtn.classList.remove("hidden");
              }
            } else {
              setVisibility(prefix, "is", false);
            }
          } else {
            setVisibility(prefix, "calisilanSure", false);
            setVisibility(prefix, "is", false);
          }
          return;
        }
        if (includesTasarim) {
          setVisibility(prefix, "urunOzelligi", true);
          if (ozellik !== "") {
            setVisibility(prefix, "adet", true);
            if (adetVal !== "") {
              setVisibility(prefix, "calisilanSure", true);
              if (calisilanSureVal !== "") {
                setVisibility(prefix, "is", true);
                if (isVal !== "") {
                  submitBtn.classList.remove("hidden");
                }
              } else {
                setVisibility(prefix, "is", false);
              }
            } else {
              setVisibility(prefix, "calisilanSure", false);
              setVisibility(prefix, "is", false);
            }
          } else {
            setVisibility(prefix, "adet", false);
            setVisibility(prefix, "calisilanSure", false);
            setVisibility(prefix, "is", false);
          }
          return;
        } else {
          setVisibility(prefix, "urunOzelligi", true);
          setVisibility(prefix, "adet", false);
          if (ozellik !== "") {
            setVisibility(prefix, "calisilanSure", true);
            if (calisilanSureVal !== "") {
              setVisibility(prefix, "is", true);
              if (isVal !== "") {
                setVisibility(prefix, "urunDurumu", true);
                submitBtn.classList.remove("hidden");
              } else {
                setVisibility(prefix, "urunDurumu", false);
              }
            } else {
              setVisibility(prefix, "is", false);
              setVisibility(prefix, "urunDurumu", false);
            }
          } else {
            setVisibility(prefix, "calisilanSure", false);
            setVisibility(prefix, "is", false);
            setVisibility(prefix, "urunDurumu", false);
          }
          return;
        }
      }
    }

    // Event listenerları yeni id'lere göre ekliyorum
    [
      {prefix: 'user_', ids: ["calismaTuru", "urunTuru", "urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"]},
      {prefix: 'admin_', ids: ["calismaTuru", "urunTuru", "urunOzelligi", "adet", "is", "odeme", "calisilanSure", "urunDurumu"]}
    ].forEach(group => {
      group.ids.forEach(id => {
        const el = document.getElementById(group.prefix + id);
        if (!el) return;
        if (["calismaTuru", "urunTuru", "urunOzelligi", "odeme", "urunDurumu"].includes(id)) {
          el.addEventListener("change", updateVisibility);
        } else {
          el.addEventListener("input", updateVisibility);
        }
      });
    });

    // Otomatik mask: __:__
    ["user_calisilanSure", "admin_calisilanSure"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", function(e) {
          let val = el.value.replace(/[^0-9]/g, "");
      if (val.length > 5) val = val.slice(0, 5);
      if (val.length > 2) {
        val = val.slice(0, val.length - 2) + ":" + val.slice(-2);
      }
          el.value = val;
        });
      }
    });

    // window.onload = ... ve eski form submit eventini de kaldır
    // document.getElementById("form").addEventListener("submit", ...); // ESKİ KODU SİL

    document.getElementById("successCloseBtn").addEventListener("click", function() {
      document.getElementById("successModal").classList.add("hidden");
      const isAdmin = document.getElementById('formAdmin').style.display !== 'none';
      if (isAdmin) {
        const isimInput = document.getElementById('admin_isimInput');
        if (isimInput) isimInput.focus();
      } else {
        const calismaTuru = document.getElementById('user_calismaTuru');
        if (calismaTuru) calismaTuru.focus();
      }
    });

    // ESC veya Enter ile successModal veya loadingModal kapansın (loginModal hariç)
    document.addEventListener('keydown', function(e) {
      const successModal = document.getElementById('successModal');
      const loadingModal = document.getElementById('loadingModal');
      if (successModal && !successModal.classList.contains('hidden')) {
        if (e.key === 'Escape' || e.key === 'Enter') {
          successModal.classList.add('hidden');
          const isAdmin = document.getElementById('formAdmin').style.display !== 'none';
          if (isAdmin) {
            const isimInput = document.getElementById('admin_isimInput');
            if (isimInput) isimInput.focus();
          } else {
            const calismaTuru = document.getElementById('user_calismaTuru');
            if (calismaTuru) calismaTuru.focus();
          }
        }
      } else if (e.key === 'Escape') {
        if (loadingModal && !loadingModal.classList.contains('hidden')) {
          loadingModal.classList.add('hidden');
          document.getElementById('formContainer').style.opacity = '1';
          document.getElementById('formContainer').style.pointerEvents = 'auto';
        }
      }
    });

    // Kullanıcı formu submit
    document.getElementById("formUser").addEventListener("submit", async function(e) {
      const submitBtn = document.getElementById("user_submitBtn");
      if (submitBtn.classList.contains("hidden") || submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      e.preventDefault();
      const calisilanSureDiv = document.getElementById("user_calisilanSureDiv");
      const calisilanSure = document.getElementById("user_calisilanSure");
      const urunTuru = document.getElementById("user_urunTuru");
      const urunOzelligi = document.getElementById("user_urunOzelligi");
      const adet = document.getElementById("user_adet");
      const isInput = document.getElementById("user_is");
      const odeme = document.getElementById("user_odeme");
      const urunDurumu = document.getElementById("user_urunDurumu");
      const calismaTuru = document.getElementById("user_calismaTuru");
      showLoading("Veriler işleniyor lütfen bekleyin...");
      const dakikaDegeri = sureyiDakikayaCevir(calisilanSure.value);
      if (calisilanSureDiv.style.display !== "none" && calisilanSure.value && dakikaDegeri === "") {
        hideLoading();
        alert("Lütfen süreyi Saat:Dakika formatında giriniz (örn: 25:30)");
        calisilanSure.focus();
        return;
      }
      let urunTuruValue = urunTuru.value;
      if (urunTuruValue === "Diğer") urunTuruValue = "Yok";
      const params = new URLSearchParams({
        apiKey: "yKybsCyyUsWBSrm",
        islem: "offlineTabloVeriIsleme",
        mail: loginMail.value,
        name: window.girisYapanIsim || '',
        password: loginPassword.value,
        calismaTuru: calismaTuru.value,
        urunTuru: urunTuruValue,
        urunOzelligi: urunOzelligi.value,
        adet: adet.value,
        is: isInput.value.trim(),
        odeme: odeme.value,
        calisilanSure: calisilanSure.value,
        urunDurumu: urunDurumu.value,
      });
      try {
        const res = await fetch(sheetUrl + "?" + params.toString());
        const json = await res.json();
        if (json.status === "success") {
          hideLoading();
          document.getElementById("successModal").classList.remove("hidden");
          const eskiMail = document.getElementById('user_mail').value;
          this.reset();
          document.getElementById('user_mailDisplay').textContent = eskiMail;
          document.getElementById('user_mail').value = eskiMail;
          updateVisibility('onlyCalismaTuru');
        } else {
          hideLoading();
          alert("Hata: " + (json.message || "Bilinmeyen hata"));
        }
      } catch (err) {
        hideLoading();
        alert("Hata: " + err.message);
      }
    });

    // Admin formu submit
    document.getElementById("formAdmin").addEventListener("submit", async function(e) {
      const submitBtn = document.getElementById("admin_submitBtn");
      if (submitBtn.classList.contains("hidden") || submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      e.preventDefault();
      const isimInput = document.getElementById("admin_isimInput");
      const isimError = document.getElementById("admin_isimError");
      const calisilanSureDiv = document.getElementById("admin_calisilanSureDiv");
      const calisilanSure = document.getElementById("admin_calisilanSure");
      const urunTuru = document.getElementById("admin_urunTuru");
      const urunOzelligi = document.getElementById("admin_urunOzelligi");
      const adet = document.getElementById("admin_adet");
      const isInput = document.getElementById("admin_is");
      const odeme = document.getElementById("admin_odeme");
      const urunDurumu = document.getElementById("admin_urunDurumu");
      const calismaTuru = document.getElementById("admin_calismaTuru");
      if (!window.isimlerListesi.includes(isimInput.value)) {
        isimError.classList.remove("hidden");
        isimError.textContent = "Lütfen listeden bir isim seçin.";
        isimInput.focus();
        hideLoading();
        return;
      } else {
        isimError.classList.add("hidden");
      }
      showLoading("Veriler işleniyor lütfen bekleyin...");
      const dakikaDegeri = sureyiDakikayaCevir(calisilanSure.value);
      if (calisilanSureDiv.style.display !== "none" && calisilanSure.value && dakikaDegeri === "") {
        hideLoading();
        alert("Lütfen süreyi Saat:Dakika formatında giriniz (örn: 25:30)");
        calisilanSure.focus();
        return;
      }
      let urunTuruValue = urunTuru.value;
      if (urunTuruValue === "Diğer") urunTuruValue = "Yok";
      const params = new URLSearchParams({
        apiKey: "yKybsCyyUsWBSrm",
        islem: "offlineTabloVeriIsleme",
        mail: loginMail.value,
        name: isimInput.value.replace('(Pasif) ', ''),
        password: loginPassword.value,
        calismaTuru: calismaTuru.value,
        urunTuru: urunTuruValue,
        urunOzelligi: urunOzelligi.value,
        adet: adet.value,
        is: isInput.value.trim(),
        odeme: odeme.value,
        calisilanSure: calisilanSure.value,
        urunDurumu: urunDurumu.value,
      });
      try {
        const res = await fetch(sheetUrl + "?" + params.toString());
        const json = await res.json();
        if (json.status === "success") {
          hideLoading();
          document.getElementById("successModal").classList.remove("hidden");
          this.reset();
          updateVisibility();
        } else {
          hideLoading();
          alert("Hata: " + (json.message || "Bilinmeyen hata"));
        }
      } catch (err) {
        hideLoading();
        alert("Hata: " + err.message);
      }
    });

    // Admin formu için isim dropdown ve arama işlevi
    let isimSecildi = false;
    let isimDropdownIndex = -1;
    let isimDropdownFiltered = [];
    const isimInput = document.getElementById("admin_isimInput");
    const isimDropdown = document.getElementById("admin_isimDropdown");
    const isimError = document.getElementById("admin_isimError");

    // Türkçe karakterleri normalize eden fonksiyon
    function turkceNormalize(str) {
      return str
        .replace(/ç/g, 'c').replace(/Ç/g, 'C')
        .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
        .replace(/ı/g, 'i').replace(/İ/g, 'I')
        .replace(/ö/g, 'o').replace(/Ö/g, 'O')
        .replace(/ş/g, 's').replace(/Ş/g, 'S')
        .replace(/ü/g, 'u').replace(/Ü/g, 'U');
    }

    function guncelleIsimDropdown() {
      const search = turkceNormalize(isimInput.value).toLowerCase();
      if (!search) {
        isimDropdownFiltered = window.isimlerListesi;
      } else {
        isimDropdownFiltered = window.isimlerListesi.filter(opt =>
          turkceNormalize(opt).toLowerCase().includes(search)
        );
      }
      if (isimDropdownFiltered.length === 0 || isimSecildi) {
        isimDropdown.classList.add("hidden");
        isimDropdown.innerHTML = "";
        isimDropdownIndex = -1;
        return;
      }
      isimDropdown.innerHTML = isimDropdownFiltered.map((opt, i) => `<div class='px-3 py-2 hover:bg-blue-100 cursor-pointer${i === isimDropdownIndex ? ' bg-blue-100' : ''}' data-value="${opt}">${opt}</div>`).join('');
      isimDropdown.classList.remove("hidden");
    }

    if (isimInput) {
      isimInput.addEventListener("input", function() {
        isimError.classList.add("hidden");
        isimSecildi = false;
        isimDropdownIndex = -1;
        guncelleIsimDropdown();
        updateVisibility();
      });
      isimInput.addEventListener("focus", function() {
        isimSecildi = false;
        isimDropdownIndex = -1;
        guncelleIsimDropdown();
      });
      isimInput.addEventListener("keydown", function(e) {
        if (isimDropdown.classList.contains("hidden")) return;
        if (isimDropdownFiltered.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          isimDropdownIndex = (isimDropdownIndex + 1) % isimDropdownFiltered.length;
          guncelleIsimDropdown();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          isimDropdownIndex = (isimDropdownIndex - 1 + isimDropdownFiltered.length) % isimDropdownFiltered.length;
          guncelleIsimDropdown();
        } else if (e.key === "Enter") {
          let indexToSelect = isimDropdownIndex;
          if (indexToSelect === -1 && isimDropdownFiltered.length > 0) {
            indexToSelect = 0;
          }
          if (indexToSelect >= 0 && indexToSelect < isimDropdownFiltered.length) {
            isimInput.value = isimDropdownFiltered[indexToSelect];
            isimSecildi = true;
            isimDropdown.classList.add("hidden");
            isimDropdownIndex = -1;
            guncelleIsimDropdown();
            updateVisibility();
            setTimeout(() => {
              const isAdmin = document.getElementById('formAdmin').style.display !== 'none';
              const calismaTuru = document.getElementById(isAdmin ? 'admin_calismaTuru' : 'user_calismaTuru');
              if (calismaTuru) calismaTuru.focus();
            }, 0);
            e.preventDefault();
          }
        } else if (e.key === "Escape") {
          isimDropdown.classList.add("hidden");
          isimDropdownIndex = -1;
        }
      });
      isimDropdown.addEventListener("mousedown", function(e) {
        if (e.target && e.target.dataset.value) {
          isimInput.value = e.target.dataset.value;
          isimSecildi = true;
          isimDropdown.classList.add("hidden");
          isimDropdownIndex = -1;
          updateVisibility();
        }
      });
      // Inputtan çıkınca dropdown'u gizle (biraz gecikmeli ki tıklama çalışsın)
      isimInput.addEventListener("blur", function() {
        setTimeout(() => isimDropdown.classList.add("hidden"), 150);
      });
    }
  </script>
</body>
</html>
